<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta charset="UTF-8">
  <title>{% block title %}BaitBlocker{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script>
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.setAttribute("data-bs-theme", savedTheme);
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
  :root[data-bs-theme='dark'] {
    --bg-color: #121212;
    --text-color: #fff;
  }
  :root[data-bs-theme='light'] {
    --bg-color: #ffffff;
    --text-color: #000;
  }
  body {
    font-family: 'Segoe UI', sans-serif;
    padding-top: 70px;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.5s ease, color 0.5s ease;
  }
  .navbar-brand { font-weight: bold; font-size: 1.6rem; }
  .card { background-color: #222; border: none; color: #eee; transition: transform 0.3s ease; }
  [data-bs-theme="light"] .card { background-color: #fff; color: #000; }
  .card:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(0, 255, 229, 0.2); }
  footer { background: #111; color: #aaa; padding: 25px 0; margin-top: 50px; text-align: center; }
  [data-bs-theme="light"] footer { background-color: #f1f1f1; color: #333; }

  /* ‚úÖ Smaller theme toggle */
  .theme-toggle { display: flex; align-items: center; gap: 6px; font-weight: 600; }
  .switch { position: relative; display: inline-block; width: 50px; height: 22px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(to right, #333, #666);
    transition: background 0.4s ease; border-radius: 20px;
  }
  .slider:before {
    content: ""; position: absolute; height: 18px; width: 18px; left: 2px; top: 2px;
    background-color: white; background-image: url('/static/moon.png'); background-size: 65%;
    background-repeat: no-repeat; background-position: center; border-radius: 50%;
    transition: transform 0.4s ease, background-image 0.4s ease; z-index: 2;
  }
  input:checked + .slider { background: linear-gradient(to right, #ffa07a, #ffcc70); }
  input:checked + .slider:before { transform: translateX(26px); background-image: url('/static/sun.png'); }

  /* ‚úÖ Profile picture inside navbar */
  #navbarProfilePic {
    width: 30px;
    height: 30px;
    object-fit: cover;
    border-radius: 50%;
    border: 1.5px solid #fff;
  }
  
  /* === Buttons === */
.btn-theme {
  background: linear-gradient(135deg, #0d6efd, #6610f2);
  color: #fff;
  border: none;
  font-weight: 600;
  border-radius: 50px;
  padding: 10px 22px;
  transition: all 0.3s ease;
}
.btn-theme:hover {
  background: linear-gradient(135deg, #6610f2, #0d6efd);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
}

/* Outline Buttons (Login / Signup) */
.btn-outline-warning, 
.btn-outline-info {
  border-radius: 50px;
  font-weight: 600;
  padding: 8px 20px;
  transition: all 0.3s ease;
}

.btn-outline-warning {
  color: #ffc107;
  border: 2px solid #ffc107;
}
.btn-outline-warning:hover {
  background-color: #ffc107;
  color: #000;
  transform: translateY(-2px);
}

.btn-outline-info {
  color: #0dcaf0;
  border: 2px solid #0dcaf0;
}
.btn-outline-info:hover {
  background-color: #0dcaf0;
  color: #000;
  transform: translateY(-2px);
}

/* Light button fix (for hero section CTA) */
.btn-light {
  font-weight: 600;
  border-radius: 50px;
  padding: 10px 22px;
  transition: all 0.3s ease;
}
.btn-light:hover {
  background-color: #f8f9fa;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
}

</style>

</head>

<body>
  <!-- Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 1100"></div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-dark navbar-dark fixed-top shadow">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">üîê BaitBlocker</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
        <div class="navbar-nav align-items-center">
          <!-- Theme Toggle -->
          <div class="theme-toggle me-3">
            <span id="themeLabel" class="text-light">Dark</span>
            <label class="switch">
              <input type="checkbox" id="modeToggle">
              <span class="slider"></span>
            </label>
          </div>

          <!-- User Menu -->
<!-- User Menu -->
{% if current_user %}
  {% set icon_src = None %}
  {% if current_user.profile_icon %}
    {% set p = current_user.profile_icon %}
    {% if p.startswith('http') %}
      {# Remote Google photo URL #}
      {% set icon_src = p %}
    {% elif p.startswith('profile_icons/') %}
      {# Already stored as a relative path under /static #}
      {% set icon_src = url_for('static', filename=p) %}
    {% else %}
      {# Just a filename, build full path #}
      {% set icon_src = url_for('static', filename='profile_icons/' ~ p) %}
    {% endif %}
  {% endif %}
  {% if not icon_src %}
    {% set icon_src = url_for('static', filename='profile_icons/default_icon.png') %}
  {% endif %}

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarProfile" role="button"
       data-bs-toggle="dropdown" aria-expanded="false">

      <img id="navbarProfilePic"
           src="{{ icon_src }}?t={{ current_user.updated_at.timestamp() if current_user.updated_at else 0 }}"
           class="rounded-circle me-2"
           style="width: 32px; height: 32px; object-fit: cover; border: 2px solid #fff;"
           alt="Profile">

      <span id="navbarProfileName" class="d-none d-md-inline">
        {{ current_user.name or 'User' }}
      </span>
    </a>

    <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="navbarProfile">
      <li>
        <a class="dropdown-item d-flex align-items-center" href="{{ url_for('profile') }}">
          <i class="bi bi-person me-2"></i> Profile
        </a>
      </li>
      <li>
        <a class="dropdown-item d-flex align-items-center" href="{{ url_for('dashboard') }}">
          <i class="bi bi-speedometer2 me-2"></i> Dashboard
        </a>
      </li>
      <li>
        <a class="dropdown-item d-flex align-items-center" href="{{ url_for('sms_phishing_detector') }}">
          <i class="bi bi-chat-dots me-2"></i> Check SMS
        </a>
      </li>
      <li>
        <a class="dropdown-item d-flex align-items-center" href="{{ url_for('mail_phishing_detector') }}">
          <i class="bi bi-envelope me-2"></i> Check Email
        </a>
      </li>
      <li>
        <a class="dropdown-item d-flex align-items-center" href="{{ url_for('url_phishing_detector') }}">
          <i class="bi bi-link-45deg me-2"></i> Check URL
        </a>
      </li>
      <li>
        <a class="dropdown-item d-flex align-items-center" href="{{ url_for('history') }}">
          <i class="bi bi-clock-history me-2"></i> History
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <a class="dropdown-item text-danger d-flex align-items-center" href="{{ url_for('logout') }}">
          <i class="bi bi-box-arrow-right me-2"></i> Logout
        </a>
      </li>
    </ul>
  </li>
{% elif request.path not in ['/login', '/register', '/firebase_login','/reset','/forgot_password','/email_sent'] %}
  <a class="btn btn-outline-warning me-2" href="{{ url_for('login') }}">Login</a>
  <a class="btn btn-outline-info" href="{{ url_for('register') }}">Sign Up</a>
{% endif %}

        </div>
      </div>
    </div>
  </nav>

  <main class="pt-5">
    {% block content %}{% endblock %}
  </main>

  {% if request.path not in ['/login', '/register', '/reset', '/forgot_password', '/email_sent','/history'] %}
<footer>
  &copy; 2025 BaitBlocker ‚Äî Securing your digital journey. Built with ‚ù§Ô∏è by Cybersecurity Enthusiasts.
</footer>
{% endif %}


  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const html = document.documentElement;
    const toggleInput = document.getElementById('modeToggle');
    const themeLabel = document.getElementById('themeLabel');

    // Update toast close button based on theme
    function updateToastCloseButtonColor() {
      const isLight = html.getAttribute("data-bs-theme") === "light";
      document.querySelectorAll('.toast .btn-close').forEach(btn => {
        btn.classList.toggle('btn-close-white', !isLight);
        btn.classList.toggle('btn-close-black', isLight);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("theme") || "dark";
      html.setAttribute("data-bs-theme", savedTheme);
      if (toggleInput) toggleInput.checked = savedTheme === "light";
      if (themeLabel) themeLabel.innerText = savedTheme === "light" ? "Light" : "Dark";
      updateToastCloseButtonColor();
    });

    if (toggleInput) {
      toggleInput.addEventListener("change", () => {
        const newTheme = toggleInput.checked ? "light" : "dark";
        html.setAttribute("data-bs-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        if (themeLabel) themeLabel.innerText = newTheme.charAt(0).toUpperCase() + newTheme.slice(1);
        updateToastCloseButtonColor();
      });
    }

    // Toast function
    function showToast(message, type="success", delay=3000){
      const toastContainer = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute("role", "alert");
      toast.setAttribute("aria-live", "assertive");
      toast.setAttribute("aria-atomic", "true");
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast, { delay: delay });
      bsToast.show();
      toast.addEventListener("hidden.bs.toast", () => toast.remove());
      updateToastCloseButtonColor();
    }

    // Navbar profile update handler with cache-busting
    function handleProfileUpdate(response) {
      if(response.success){
        if(response.name){
          const nameEl = document.getElementById("navbarProfileName");
          if(nameEl) nameEl.innerText = response.name;
        }
        if(response.profile_icon_url){
          const iconEl = document.getElementById("navbarProfilePic");
          if(iconEl) iconEl.src = response.profile_icon_url + "?t=" + new Date().getTime();
        }
        showToast("‚úÖ Profile updated successfully!");
      } else {
        showToast("‚ùå " + (response.error || "Profile update failed"), "danger");
      }
    }
  </script>
</body>
</html>
