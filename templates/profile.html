{% extends "base.html" %}
{% block title %}Profile - BaitBlocker{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
    <h2 class="fw-bold mb-4">üë§ My Profile</h2>

    <!-- Profile Card -->
    <div class="card shadow-lg border-0 rounded-4 mx-auto p-4" style="max-width: 450px; background: linear-gradient(145deg, #1a1a1a, #222); color: #f1f1f1;">
        <div class="position-relative d-inline-block mx-auto">
            {% set icon_file = user.profile_icon if user.profile_icon else 'profile_icons/default_icon.png' %}
            <img id="profilePageImg"
                 src="{{ url_for('static', filename=icon_file) }}?t={{ session['user'].get('profile_icon_timestamp', 0) }}"
                 onerror="this.src='{{ url_for('static', filename='profile_icons/default_icon.png') }}';"
                 class="rounded-circle border border-3 border-light shadow profile-hover"
                 width="100" height="100" style="object-fit: cover;">
        </div>

        <h4 id="profilePageName" class="fw-bold">{{ user.name }}</h4>
        <p class="mb-1"><i class="bi bi-envelope-fill text-info"></i> {{ user.email }}</p>
        <p class="mb-3"><i class="bi bi-phone-fill text-warning"></i> <span id="profilePagePhone">{{ user.phone or 'Not added' }}</span></p>

        <!-- Stats / Badges -->
        <div class="mb-3">
            <span class="badge rounded-pill bg-info text-dark px-3 py-2">‚úÖ Checks Done: {{ user.checks_done or 0 }}</span>
            {% if user.is_premium %}
                <span class="badge rounded-pill bg-success px-3 py-2">üåü Premium User</span>
            {% else %}
                <span class="badge rounded-pill bg-secondary px-3 py-2">Free User</span>
            {% endif %}
        </div>

        <p class="small profile-card-member-since">üìÖ Member since: {{ user.created_at | format_datetime }}</p>

        <!-- Buttons -->
        <div class="d-flex justify-content-center gap-2 mt-3 flex-wrap">
            <button class="btn btn-outline-light btn-profile" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <i class="bi bi-pencil-square"></i> Edit Profile
            </button>
            <button class="btn btn-outline-secondary btn-profile" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                <i class="bi bi-key-fill"></i> Change Password
            </button>
            <button class="btn btn-outline-danger btn-profile" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                <i class="bi bi-trash"></i> Delete
            </button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-warning btn-profile">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">‚úèÔ∏è Edit Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="profileForm" method="POST" enctype="multipart/form-data">
        <div class="modal-body text-center">
          <!-- Profile Picture -->
          <div class="mb-3 position-relative d-inline-block">
            <img id="profileModalPreview" 
                 src="{{ url_for('static', filename=icon_file) }}?t={{ session['user'].get('profile_icon_timestamp', 0) }}"
                 onerror="this.src='{{ url_for('static', filename='profile_icons/default_icon.png') }}';"
                 class="rounded-circle border border-3 border-light shadow profile-hover"
                 width="100" height="100" style="object-fit: cover;">

            <label for="profileIconInput" class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-1 cursor-pointer" style="transform: translate(25%, 25%);">
              <i class="bi bi-camera-fill"></i>
            </label>
            <input type="file" name="profile_icon" id="profileIconInput" class="d-none" accept="image/*">
          </div>

          <div class="mb-3 text-start">
            <label class="form-label fw-semibold">Full Name</label>
            <input type="text" name="name" class="form-control form-control-sm bg-dark text-light border-1 border-secondary" value="{{ user.name }}" required>
          </div>

          <div class="mb-3 text-start">
            <label class="form-label fw-semibold">Mobile Number <span class="text-danger">*</span></label>
            <input type="text" name="phone" class="form-control form-control-sm bg-dark text-light border-1 border-secondary" value="{{ user.phone }}" required>
          </div>

        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success btn-sm">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">üîí Change Password</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="changePasswordForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <input type="password" name="new_password" class="form-control" placeholder="Enter new password" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input type="password" name="confirm_password" class="form-control" placeholder="Confirm new password" required>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Change Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-3">
      <div class="modal-body text-center">
        <h5 class="mb-3">‚ö†Ô∏è Confirm Deletion</h5>
        <p class="small">This action cannot be undone. Are you sure?</p>
        <div class="d-flex justify-content-center gap-2 mt-3">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="deleteAccountBtn" class="btn btn-danger">Yes, Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Profile image hover effect */
  .profile-hover:hover {
    transform: scale(1.05);
    transition: 0.3s ease-in-out;
    box-shadow: 0 0 20px rgba(0,255,200,0.4);
  }

  /* Member since text */
  .profile-card-member-since {
    color: #f1f1f1 !important;
  }

  /* ===== BUTTON STYLES ===== */
  .btn-profile {
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease-in-out;
    color: #fff;
    border: 2px solid #0ff;
    background-color: transparent;
}

.btn-profile:hover {
    background-color: #0ff;
    color: #000;
    border-color: #0ff;
}


  .btn-outline-light.btn-profile {
    color: #fff;
    border-color: #fff;
  }
  .btn-outline-light.btn-profile:hover {
    background-color: #0ff;
    color: #000;
    border-color: #0ff;
  }

  .btn-outline-secondary.btn-profile {
    color: #ccc;
    border-color: #ccc;
  }
  .btn-outline-secondary.btn-profile:hover {
    background-color: #6c757d;
    color: #fff;
    border-color: #6c757d;
  }

  .btn-outline-danger.btn-profile {
    color: #dc3545;
    border-color: #dc3545;
  }
  .btn-outline-danger.btn-profile:hover {
    background-color: #dc3545;
    color: #fff;
    border-color: #dc3545;
  }

  .btn-outline-warning.btn-profile {
    color: #ffc107;
    border-color: #ffc107;
  }
  .btn-outline-warning.btn-profile:hover {
    background-color: #ffc107;
    color: #000;
    border-color: #ffc107;
  }

   /* Modal gradient background */
  .bg-gradient-dark {
    background: linear-gradient(145deg, #1c1c1c, #2a2a2a);
  }

  /* Profile image hover effect */
  .profile-hover:hover {
    transform: scale(1.05);
    transition: 0.3s ease-in-out;
    box-shadow: 0 0 20px rgba(0,255,200,0.4);
  }

  /* File input label as camera button */
  .cursor-pointer { cursor: pointer; }

  /* Input fields */
  .modal-content .form-control {
    border-radius: 0.5rem;
    transition: all 0.3s ease-in-out;
  }
  .modal-content .form-control:focus {
    border-color: #0ff;
    box-shadow: 0 0 8px rgba(0, 255, 200, 0.3);
    outline: none;
  }
  /* Footer buttons */
  .modal-footer .btn-profile {
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease-in-out;
    min-width: 120px;
  }
  .modal-footer .btn-profile:hover {
    transform: translateY(-2px);
  }
</style>


<script>
document.addEventListener("DOMContentLoaded", () => {
    // Profile Image Preview
    const profileIconInput = document.getElementById("profileIconInput");
    const profileModalPreview = document.getElementById("profileModalPreview");
    if(profileIconInput){
        profileIconInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = () => profileModalPreview.src = reader.result;
                reader.readAsDataURL(file);
            }
        });
    }

    // AJAX Profile Update
    const profileForm = document.getElementById("profileForm");
    profileForm.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(profileForm);
        try {
            const response = await fetch('{{ url_for("edit_profile") }}', {method:'POST', body: formData});
            const data = await response.json();
            if(data.success){
                document.getElementById("profilePageName").innerText = data.name;
                document.getElementById("profilePagePhone").innerText = data.phone || 'Not added';
                document.getElementById("profilePageImg").src = data.profile_icon_url + `?t=${Date.now()}`;
                document.getElementById("profileModalPreview").src = data.profile_icon_url + `?t=${Date.now()}`;
                const navbarProfilePic = document.getElementById("navbarProfilePic");
                if(navbarProfilePic) navbarProfilePic.src = data.profile_icon_url + `?t=${Date.now()}`;
                const navbarProfileName = document.getElementById("navbarProfileName");
                if(navbarProfileName) navbarProfileName.innerText = data.name;
                bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                showToast("Profile updated successfully!", "success");
            } else {
                showToast("Error: " + data.error, "danger");
            }
        } catch(err){
            console.error(err);
            showToast("Something went wrong. Please try again.", "danger");
        }
    });

    // AJAX Change Password
    const changePasswordForm = document.getElementById("changePasswordForm");
    changePasswordForm.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(changePasswordForm);
        try {
            const response = await fetch('{{ url_for("change_password") }}', {method:'POST', body: formData});
            const data = await response.json();
            if(data.success){
                bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'))?.hide();
                showToast("Password changed successfully!", "success");
                changePasswordForm.reset();
            } else {
                showToast("Error: " + data.error, "danger");
            }
        } catch(err){
            console.error(err);
            showToast("Something went wrong. Please try again.", "danger");
        }
    });

    // Delete Account
    document.getElementById("deleteAccountBtn").addEventListener('click', async () => {
        try {
            const response = await fetch('{{ url_for("delete_account") }}', {method:'POST'});
            const data = await response.json();
            if(data.success){
                setTimeout(()=>{ window.location.href = "{{ url_for('login') }}"; }, 1000);
            } else {
                showToast("Error: "+data.error, "danger");
            }
        } catch(err){
            console.error(err);
            showToast("Something went wrong. Please try again.", "danger");
        }
    });
});
</script>
{% endblock %}